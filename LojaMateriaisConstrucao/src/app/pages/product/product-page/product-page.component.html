<!-- 1. Estado de Carregamento -->
@if (loading()) {
  <div class="h-screen flex flex-col items-center justify-center text-gray-500 gap-4 bg-gray-50">
    <div class="bg-white p-4 rounded-full shadow-sm">
        <i class="ph-duotone ph-spinner animate-spin text-4xl text-brand-600"></i>
    </div>
    <p class="animate-pulse font-medium text-sm">Carregando detalhes do produto...</p>
  </div>
} 
@else {
  <!-- 2. Verifica se o produto existe e cria o alias 'p' -->
  @if (product(); as p) {
    <main class="container mx-auto px-4 pt-28 pb-12 animate-fade-in">
        
        <!-- Navegação Breadcrumb -->
        <nav class="flex text-sm text-gray-500 mb-6 overflow-x-auto whitespace-nowrap pb-2 items-center">
            <a routerLink="/" class="hover:text-brand-600 transition-colors flex items-center gap-1">
                <i class="ph-fill ph-house"></i> Home
            </a>
            <i class="ph-bold ph-caret-right text-xs mx-2 text-gray-300"></i>
            <a class="hover:text-brand-600 transition-colors cursor-pointer">
                {{ p.categoria?.nome || 'Geral' }}
            </a>
            <i class="ph-bold ph-caret-right text-xs mx-2 text-gray-300"></i>
            <span class="text-gray-900 font-medium truncate">{{ p.titulo }}</span>
        </nav>
        
        <!-- Seção Principal do Produto -->
        <div class="bg-white rounded-[2rem] p-6 lg:p-8 shadow-sm border border-gray-100 flex flex-col lg:flex-row gap-10">
            
            <!-- Coluna Esquerda: Galeria de Imagens com Zoom -->
            <div class="w-full lg:w-7/12 xl:w-1/2 flex flex-col gap-6">
                
                <!-- Container da Imagem Principal (ZOOM) -->
                <div 
                class="relative w-full aspect-[4/3] sm:aspect-square md:aspect-[4/3] lg:aspect-square bg-white rounded-3xl overflow-hidden border border-gray-100 group cursor-zoom-in flex items-center justify-center shadow-inner"
                (mousemove)="onMouseMove($event)"
                (mouseleave)="onMouseLeave()">
                
                <!-- Imagem Real -->
                <img 
                [src]="currentImage()" 
                [alt]="p.titulo"
                class="w-full h-full object-contain p-8 transition-transform duration-200 ease-out z-0"
                [style.transform]="zoomTransform()"
                [style.transform-origin]="zoomOrigin()">
                
                <!-- Badges Personalizadas -->
                <div class="absolute top-0 left-4 flex flex-col gap-2 z-10 pointer-events-none">
                    @if (p.precoPromocional) {
                        <div class="relative bg-red-600 text-white w-10 pb-2 pt-3 flex flex-col items-center justify-center rounded-b-full shadow-lg shadow-red-900/20 transform transition-transform group-hover:translate-y-1">
                            <span class="text-[10px] font-black leading-none">{{ discountPercentage() }}%</span>
                            <span class="text-[8px] font-bold uppercase mt-0.5">OFF</span>
                        </div>
                    }
                    @if (p.estoque > 0) {
                        <div class="mt-2 bg-white/90 backdrop-blur border border-green-200 text-green-700 text-[10px] font-bold px-3 py-1.5 rounded-full shadow-sm flex items-center gap-1.5 animate-fade-in-up">
                            <span class="relative flex h-2 w-2">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                            </span>
                            Entrega Rápida
                        </div>
                    } @else {
                        <div class="mt-2 bg-gray-900 text-white text-[10px] font-bold px-3 py-1.5 rounded-full shadow-sm flex items-center gap-1.5 animate-fade-in-up">
                            <i class="ph-bold ph-prohibit"></i> Esgotado
                        </div>
                    }
                </div>
                
                <!-- Botão Favorito Flutuante -->
                <button (click)="toggleFavorite()" 
                        class="absolute top-4 right-4 p-3 rounded-full shadow-lg backdrop-blur-md transition-all z-20 group/heart border border-gray-100 hover:scale-110 active:scale-95"
                        [ngClass]="favoritoService.isFavorito(p.id) 
                            ? 'bg-red-50 text-red-500 border-red-100' 
                            : 'bg-white/90 text-gray-400 hover:text-red-500 hover:bg-white'">
                    <i [class]="favoritoService.isFavorito(p.id) ? 'ph-fill ph-heart text-xl' : 'ph-bold ph-heart text-xl'"></i>
                </button>
            </div>
            
            <!-- Thumbnails -->
            <div class="grid grid-cols-5 gap-3">
                @for (img of productImages(); track $index) {
                    <div 
                    (click)="changeImage(img)"
                    class="aspect-square rounded-2xl overflow-hidden border-2 cursor-pointer transition-all bg-white p-1"
                    [ngClass]="currentImage() === img ? 'border-brand-500 ring-2 ring-brand-100' : 'border-transparent hover:border-gray-200'">
                    <img [src]="img" class="w-full h-full object-contain rounded-xl">
                </div>
            }
        </div>
    </div>
    
    <!-- Coluna Direita: Informações de Compra -->
    <div class="w-full lg:w-5/12 xl:w-1/2 flex flex-col">
        <div class="mb-6 border-b border-gray-100 pb-6">
            <div class="flex items-center justify-between mb-3">
                <span class="text-[10px] font-bold text-brand-700 bg-brand-50 px-2.5 py-1 rounded-lg uppercase tracking-wider border border-brand-100">
                    {{ productExtras.brand }}
                </span>
                <div class="flex items-center gap-1.5 text-gray-400 bg-gray-50 px-2 py-1 rounded-lg border border-gray-100">
                    <i class="ph-bold ph-barcode text-xs"></i>
                    <span class="text-[10px] font-mono font-medium">{{ p.codigoControle }}</span>
                </div>
            </div>
            
            <h1 class="text-2xl md:text-3xl lg:text-4xl font-black text-gray-900 leading-tight mb-4 tracking-tight">
                {{ p.titulo }}
            </h1>
            
            <div class="flex flex-wrap items-center gap-3 text-sm">
                <!-- Rating -->
                <div class="flex items-center gap-1.5 bg-yellow-50 px-3 py-1.5 rounded-xl border border-yellow-100">
                    <div class="flex text-sm gap-0.5 text-yellow-400">
                        <i class="ph-fill ph-star"></i>
                        <i class="ph-fill ph-star"></i>
                        <i class="ph-fill ph-star"></i>
                        <i class="ph-fill ph-star"></i>
                        <i class="ph-fill ph-star-half"></i>
                    </div>
                    <span class="font-bold text-gray-900 text-xs ml-1">{{ productExtras.rating }}</span>
                </div>
                <span class="text-gray-400 text-xs">|</span>
                <span class="text-gray-500 text-xs"><strong>{{ productExtras.reviewsCount }}</strong> avaliações</span>
            </div>
        </div>
        
        <!-- Preço e Pagamento Compacto -->
        <div class="mb-8">
            <div class="flex items-baseline gap-3 flex-wrap mb-1">
                @if (p.precoPromocional) {
                    <span class="text-gray-400 line-through text-lg font-medium decoration-red-400/50">{{ p.preco | currency:'BRL' }}</span>
                }
            </div>
            
            <div class="flex items-end gap-1 mb-6">
                <span class="text-sm font-bold text-gray-500 mb-1.5">R$</span>
                <span class="text-5xl font-black text-gray-900 tracking-tighter leading-none">
                    {{ finalPrice() | number:'1.2-2' }}
                </span>
                <span class="text-xs font-bold text-gray-400 mb-1.5 ml-1">à vista</span>
            </div>
            
            <!-- Formas de Pagamento (Ícone + Nome lado a lado) -->
            <div class="grid grid-cols-3 gap-2">
                
                <!-- PIX -->
                <div class="group relative flex flex-col items-center justify-center p-2 rounded-xl border border-gray-100 bg-white hover:border-green-200 hover:bg-green-50/30 hover:shadow-md transition-all cursor-pointer h-full">
                    <div class="flex items-center gap-1.5 mb-1.5">
                        <i class="ph-bold ph-pix-logo text-green-600 text-lg"></i>
                        <span class="text-[10px] font-bold text-gray-700 uppercase tracking-wide">Pix</span>
                    </div>
                    <span class="text-[9px] font-bold text-green-600 bg-green-100/50 px-2 py-0.5 rounded-full">-5% OFF</span>
                </div>

                <!-- BOLETO -->
                <div class="group flex flex-col items-center justify-center p-2 rounded-xl border border-gray-100 bg-white hover:border-gray-300 hover:shadow-md transition-all cursor-pointer h-full">
                    <div class="flex items-center gap-1.5 mb-1.5">
                        <i class="ph-bold ph-barcode text-gray-500 text-lg"></i>
                        <span class="text-[10px] font-bold text-gray-700 uppercase tracking-wide">Boleto</span>
                    </div>
                    <span class="text-[9px] text-gray-400 font-medium">À vista</span>
                </div>

                <!-- CARTÃO (Com Dropdown de Parcelas) -->
                <div class="group relative flex flex-col items-center justify-center p-2 rounded-xl border border-gray-100 bg-white hover:border-brand-200 hover:bg-brand-50/10 hover:shadow-md transition-all cursor-pointer h-full">
                    <div class="flex items-center gap-1.5 mb-1.5">
                        <i class="ph-bold ph-credit-card text-brand-600 text-lg"></i>
                        <span class="text-[10px] font-bold text-gray-700 uppercase tracking-wide">Cartão</span>
                    </div>
                    <span class="text-[9px] text-brand-600 font-bold bg-brand-50/50 px-2 py-0.5 rounded-full">12x</span>

                    <!-- Tooltip/Dropdown de Parcelas -->
                    <div class="absolute right-0 top-full mt-2 w-56 bg-white border border-gray-100 rounded-xl shadow-xl z-30 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform translate-y-2 group-hover:translate-y-0 pointer-events-none group-hover:pointer-events-auto overflow-hidden">
                        <div class="bg-gray-50/50 px-4 py-3 border-b border-gray-50 flex justify-between items-center">
                            <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Parcelamento</span>
                            <i class="ph-bold ph-cardholder text-brand-400"></i>
                        </div>
                        <div class="max-h-48 overflow-y-auto scrollbar-hide p-2">
                            @for (i of [1,2,3,6,10,12]; track i) {
                                <div class="flex justify-between items-center px-3 py-2 hover:bg-brand-50 rounded-xl text-xs transition-colors group/item">
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-brand-600 w-5">{{ i }}x</span>
                                        <span class="text-gray-500">de</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-gray-900">{{ (finalPrice() / i) | currency:'BRL' }}</span>
                                        @if(i <= 3) { 
                                            <span class="text-[9px] text-green-600 bg-green-50 px-1.5 rounded font-bold">S/J</span> 
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ações -->
        <div class="flex flex-col sm:flex-row gap-4 mb-8">
            <!-- Seletor de Quantidade -->
            <div class="flex items-center justify-between border-2 border-gray-100 rounded-2xl bg-white w-full sm:w-40 hover:border-gray-300 transition-colors p-1">
                <button class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-brand-600 hover:bg-brand-50 rounded-xl transition-all active:scale-90" 
                        (click)="updateQty(-1)"
                        [disabled]="quantity() <= 1">
                    <i class="ph-bold ph-minus"></i>
                </button>
                <input type="number" [value]="quantity()" readonly class="w-12 text-center font-bold text-lg text-gray-900 outline-none border-none p-0 bg-transparent">
                <button class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-brand-600 hover:bg-brand-50 rounded-xl transition-all active:scale-90" 
                        (click)="updateQty(1)">
                    <i class="ph-bold ph-plus"></i>
                </button>
            </div>

            <!-- Botão Adicionar -->
            <button 
            (click)="addToCart()"
            [disabled]="p.estoque <= 0"
            class="flex-1 bg-gray-900 hover:bg-brand-600 text-white font-bold h-14 rounded-2xl shadow-xl shadow-gray-200 hover:shadow-brand-200 transition-all transform active:scale-[0.98] flex items-center justify-center gap-3 text-base disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-400 disabled:shadow-none group"
            >
                @if (p.estoque > 0) {
                    <i class="ph-bold ph-shopping-cart text-xl group-hover:animate-bounce-short"></i>
                    <span>Adicionar ao Carrinho</span>
                } @else {
                    <i class="ph-bold ph-bell-simple-slash text-xl"></i>
                    <span>Avise-me quando chegar</span>
                }
            </button>
        </div>
    
        <!-- Calculadora de Frete (Novo Componente) -->
        <app-shipping-calculator 
            [initialZipCode]="zipCode()" 
            (shippingSelected)="calculateShipping()">
        </app-shipping-calculator>

  </div>
  </div>
  
  <!-- SEÇÃO DE ABAS (Overview, Specs, Reviews) -->
  <div class="mt-12 bg-white rounded-[2.5rem] shadow-sm border border-gray-100 overflow-hidden">
    <div class="border-b border-gray-100 bg-gray-50/30 px-6 lg:px-10">
        <nav class="flex space-x-8 overflow-x-auto scrollbar-hide">
            <button (click)="setActiveTab('overview')" 
                    class="group relative py-5 text-sm font-bold transition-colors focus:outline-none" 
                    [class.text-brand-600]="activeTab() === 'overview'" 
                    [class.text-gray-500]="activeTab() !== 'overview'">
                Visão Geral
                <span class="absolute bottom-0 left-0 w-full h-1 bg-brand-500 rounded-t-full transition-transform duration-300" 
                      [class.scale-x-100]="activeTab() === 'overview'" 
                      [class.scale-x-0]="activeTab() !== 'overview'"></span>
            </button>
            <button (click)="setActiveTab('specs')" 
                    class="group relative py-5 text-sm font-bold transition-colors focus:outline-none" 
                    [class.text-brand-600]="activeTab() === 'specs'" 
                    [class.text-gray-500]="activeTab() !== 'specs'">
                Especificações
                <span class="absolute bottom-0 left-0 w-full h-1 bg-brand-500 rounded-t-full transition-transform duration-300" 
                      [class.scale-x-100]="activeTab() === 'specs'" 
                      [class.scale-x-0]="activeTab() !== 'specs'"></span>
            </button>
            <button (click)="setActiveTab('reviews')" 
                    class="group relative py-5 text-sm font-bold transition-colors focus:outline-none" 
                    [class.text-brand-600]="activeTab() === 'reviews'" 
                    [class.text-gray-500]="activeTab() !== 'reviews'">
                Avaliações <span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-[10px] ml-1">{{ productExtras.reviewsCount }}</span>
                <span class="absolute bottom-0 left-0 w-full h-1 bg-brand-500 rounded-t-full transition-transform duration-300" 
                      [class.scale-x-100]="activeTab() === 'reviews'" 
                      [class.scale-x-0]="activeTab() !== 'reviews'"></span>
            </button>
        </nav>
    </div>
  
    <div class="p-6 lg:p-12 min-h-[400px]">
        <!-- Conteúdo das Abas -->
        @if (activeTab() === 'overview') {
            <div class="animate-fade-in max-w-5xl mx-auto space-y-16">
                <div class="flex flex-col md:flex-row items-start gap-12">
                    <div class="md:w-1/2 space-y-6">
                        <h2 class="text-3xl font-black text-gray-900">Sobre o Produto</h2>
                        <div class="prose prose-sm prose-gray text-gray-600 leading-relaxed whitespace-pre-line">
                            {{ p.descricao }}
                        </div>
                    </div>
                    <div class="md:w-1/2">
                        <div class="bg-gray-50 rounded-3xl h-80 flex items-center justify-center text-gray-300 overflow-hidden border border-gray-100 shadow-inner">
                             <img [src]="currentImage()" class="w-full h-full object-cover opacity-90 mix-blend-multiply hover:scale-105 transition-transform duration-700">
                        </div>
                    </div>
                </div>
            </div>
        }
        
        @if (activeTab() === 'specs') {
            <div class="animate-fade-in max-w-3xl mx-auto">
                <div class="border border-gray-100 rounded-2xl overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <tbody class="divide-y divide-gray-100">
                            <!-- Specs Reais do DTO -->
                            @if (p.dimensoes) {
                                <tr class="group hover:bg-gray-50/50">
                                    <td class="py-4 px-6 font-bold text-gray-900 w-1/3 bg-gray-50/30">Dimensões</td>
                                    <td class="py-4 px-6 text-gray-600 font-mono">{{ p.dimensoes }}</td>
                                </tr>
                            }
                            @if (p.pesoKg) {
                                <tr class="group hover:bg-gray-50/50">
                                    <td class="py-4 px-6 font-bold text-gray-900 w-1/3 bg-gray-50/30">Peso</td>
                                    <td class="py-4 px-6 text-gray-600">{{ p.pesoKg }} kg</td>
                                </tr>
                            }
                            <!-- Specs Mockadas -->
                            @for (spec of productExtras.specs; track spec.label) {
                                <tr class="group hover:bg-gray-50/50">
                                    <td class="py-4 px-6 font-bold text-gray-900 w-1/3 bg-gray-50/30">{{ spec.label }}</td>
                                    <td class="py-4 px-6 text-gray-600">{{ spec.value }}</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
        
        @if (activeTab() === 'reviews') {
            <div class="animate-fade-in max-w-3xl mx-auto space-y-8">
                @for (review of productExtras.reviews; track review.user) {
                    <div class="border-b border-gray-100 pb-8 last:border-0 last:pb-0">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-brand-50 flex items-center justify-center text-brand-700 font-bold text-sm shadow-sm ring-2 ring-white">
                                    {{ review.user.substring(0,2) }}
                                </div>
                                <div>
                                    <span class="font-bold text-gray-900 text-sm block">{{ review.user }}</span>
                                    <div class="flex text-yellow-400 text-xs gap-0.5 mt-0.5">
                                        @for (star of [1,2,3,4,5]; track star) {
                                            @if (review.rating >= star) { <i class="ph-fill ph-star"></i> }
                                            @else { <i class="ph-fill ph-star text-gray-200"></i> }
                                        }
                                    </div>
                                </div>
                            </div>
                            <span class="text-xs text-gray-400 font-medium bg-gray-50 px-2 py-1 rounded-lg">{{ review.date }}</span>
                        </div>
                        <p class="text-gray-600 text-sm leading-relaxed pl-13">{{ review.text }}</p>
                    </div>
                }
            </div>
        }
    </div>
  </div>
  </main>
  }
  @else {
    <!-- 3. Caso Raro: Nem loading nem produto -->
    <div class="h-screen flex flex-col items-center justify-center text-gray-400 gap-6 bg-gray-50">
        <div class="bg-white p-8 rounded-full shadow-sm">
            <i class="ph-duotone ph-package text-6xl text-gray-300"></i>
        </div>
        <div class="text-center">
            <h3 class="text-xl font-bold text-gray-900">Produto não encontrado</h3>
            <p class="text-sm mt-2 max-w-xs mx-auto">O item que você procura pode ter sido removido ou o link está incorreto.</p>
        </div>
        <a routerLink="/" class="text-brand-600 font-bold hover:underline flex items-center gap-2">
            <i class="ph-bold ph-arrow-left"></i> Voltar para a loja
        </a>
    </div>
  }
}