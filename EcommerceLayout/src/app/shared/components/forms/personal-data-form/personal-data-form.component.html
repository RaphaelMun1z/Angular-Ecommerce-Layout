<div class="relative">
    
    <div class="flex flex-col md:flex-row items-start md:items-center gap-6 mb-10">
        <div class="relative group shrink-0">
            <div class="w-24 h-24 rounded-full overflow-hidden border-4 border-white shadow-md transition-all relative z-10"
                 [class.ring-2]="isUploading()" [class.ring-orange-500]="isUploading()" [class.opacity-50]="isUploading()">
                <img [src]="user().avatar" class="w-full h-full object-cover" (error)="handleImageError($event)">
            </div>
            
            @if (isEditingMode()) {
                <label class="absolute bottom-0 right-0 z-20 bg-gray-900 text-white p-2 rounded-full cursor-pointer hover:bg-orange-600 transition-all hover:scale-105 shadow-lg border-2 border-white group-hover:bg-orange-600">
                    @if (isUploading()) {
                        <i class="ph-bold ph-spinner animate-spin text-sm"></i>
                    } @else {
                        <i class="ph-bold ph-camera text-sm"></i>
                    }
                    <input type="file" class="hidden" accept="image/*" (change)="onAvatarSelected($event)" [disabled]="isUploading()">
                </label>
            }
        </div>

        <div class="flex-1">
            <h2 class="text-2xl font-bold text-gray-900 tracking-tight">Editar Perfil</h2>
            <p class="text-gray-500 mt-1">Atualize suas informações pessoais e de contato.</p>
        </div>

        @if (!isEditingMode()) {
            <button (click)="toggleEditing()" 
                    class="px-5 py-2.5 rounded-xl bg-gray-900 text-white font-semibold text-sm hover:bg-orange-600 transition-all shadow-sm flex items-center gap-2">
                <i class="ph-bold ph-pencil-simple"></i>
                Editar Perfil
            </button>
        }
    </div>
    
    <form (submit)="savePersonalData($event)" class="space-y-6">
        
        <div class="space-y-1.5">
            <label class="text-sm font-semibold text-gray-700 ml-1">Nome Completo</label>
            <div class="relative group">
                <input type="text" 
                       [(ngModel)]="formData.nome" 
                       name="nome" 
                       [disabled]="!isEditingMode()"
                       placeholder="Seu nome completo"
                       class="w-full bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-xl px-4 py-3.5 placeholder:text-gray-400 focus:outline-none focus:border-orange-500 focus:bg-white focus:ring-4 focus:ring-orange-500/10 transition-all disabled:opacity-70 disabled:bg-gray-50/50">
                
                @if (formData.nome && isEditingMode()) {
                    <div class="absolute inset-y-0 right-4 flex items-center pointer-events-none animate-fade-in">
                        <i class="ph-fill ph-check-circle text-orange-500 text-xl"></i>
                    </div>
                }
            </div>
        </div>

        <div class="space-y-1.5">
            <label class="text-sm font-semibold text-gray-700 ml-1">E-mail</label>
            <div class="relative">
                <input type="email" 
                       [value]="user().email" 
                       disabled 
                       class="w-full bg-gray-50 border border-gray-200 text-gray-500 text-sm rounded-xl px-4 py-3.5 cursor-not-allowed">
                <div class="absolute inset-y-0 right-4 flex items-center pointer-events-none">
                    <i class="ph-bold ph-lock-key text-gray-400 text-lg"></i>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            @if (user().isCliente) {
                <div class="space-y-1.5">
                    <label class="text-sm font-semibold text-gray-700 ml-1">CPF</label>
                    <div class="relative">
                        <input type="text" 
                               [(ngModel)]="formData.cpf" 
                               name="cpf" 
                               mask="000.000.000-00" 
                               [disabled]="!isEditingMode()"
                               placeholder="000.000.000-00"
                               class="w-full bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-xl px-4 py-3.5 placeholder:text-gray-400 focus:outline-none focus:border-orange-500 focus:bg-white focus:ring-4 focus:ring-orange-500/10 transition-all disabled:opacity-70">
                        
                         @if (formData.cpf && isEditingMode()) {
                            <div class="absolute inset-y-0 right-4 flex items-center pointer-events-none animate-fade-in">
                                <i class="ph-fill ph-check-circle text-orange-500 text-xl"></i>
                            </div>
                        }
                    </div>
                </div>

                <div class="space-y-1.5">
                    <label class="text-sm font-semibold text-gray-700 ml-1">Telefone / WhatsApp</label>
                    <div class="relative">
                        <input type="text" 
                               [(ngModel)]="formData.telefone" 
                               name="telefone" 
                               mask="(00) 0 0000-0000" 
                               [disabled]="!isEditingMode()"
                               placeholder="(00) 0 0000-0000"
                               class="w-full bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-xl px-4 py-3.5 placeholder:text-gray-400 focus:outline-none focus:border-orange-500 focus:bg-white focus:ring-4 focus:ring-orange-500/10 transition-all disabled:opacity-70">
                    </div>
                </div>
            }
        </div>

        @if (isEditingMode()) {
             <div class="py-2">
                <div class="flex items-start gap-3 text-gray-500 text-xs px-1 bg-orange-50 p-3 rounded-lg border border-orange-100">
                     <i class="ph-fill ph-info text-orange-500 text-lg mt-0.5"></i>
                     <p>Dados sensíveis como e-mail requerem contato com o suporte para alteração.</p>
                </div>
             </div>
        }

        @if (isEditingMode()) {
            <div class="flex items-center justify-end gap-3 pt-6 border-t border-gray-100 mt-4 animate-slide-up">
                <button type="button" 
                        (click)="cancelEditing()" 
                        class="px-6 py-3 rounded-xl border border-gray-200 text-gray-600 font-bold text-sm hover:bg-red-50 hover:text-red-600 hover:border-red-100 transition-all cursor-pointer">
                    Cancelar
                </button>
                
                <button type="submit" 
                        [disabled]="isSaving()"
                        class="px-6 py-3 rounded-xl bg-gray-900 text-white font-bold text-sm shadow-lg shadow-gray-200 hover:bg-orange-600 hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center gap-2 cursor-pointer disabled:opacity-70 disabled:cursor-not-allowed">
                    @if (isSaving()) { <i class="ph-bold ph-spinner animate-spin"></i> }
                    Salvar Alterações
                </button>
            </div>
        }
    </form>
</div>