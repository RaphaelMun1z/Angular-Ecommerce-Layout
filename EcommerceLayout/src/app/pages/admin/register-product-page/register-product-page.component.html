<div class="min-h-screen bg-white flex flex-col md:flex-row font-sans">
    
    <!-- Painel Lateral (Stepper) -->
    <aside class="w-full md:w-[320px] lg:w-[380px] bg-[#FAFAFA] border-r border-gray-100 p-8 md:p-12 flex flex-col min-h-[200px] md:min-h-screen">
        
        <!-- Logo / Voltar -->
        <div class="flex items-center gap-3 mb-12">
            <button routerLink="/dashboard-admin/produtos" class="w-8 h-8 rounded-lg bg-[#5252FF]/10 flex items-center justify-center text-[#5252FF] hover:bg-[#5252FF]/20 transition-colors cursor-pointer">
                <i class="ph-bold ph-arrow-left text-lg"></i>
            </button>
            <h1 class="text-xl font-bold text-gray-900 tracking-tight">
                {{ isEditing() ? 'Editar Produto' : 'Novo Produto' }}
            </h1>
        </div>

        <!-- Passos -->
        <div class="flex-1">
            <div class="flex flex-col gap-8 relative">
                @for (step of steps; track step.id; let isLast = $last) {
                    <div class="relative flex gap-5">
                        
                        <!-- Linha de conexão vertical -->
                        @if (!isLast) {
                            <div class="absolute left-4 top-10 bottom-[-2rem] w-[2px]"
                                 [ngClass]="currentStep() > step.id ? 'bg-[#5252FF]' : 'bg-gray-200'">
                            </div>
                        }

                        <!-- Círculo do Passo -->
                        <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 relative z-10 transition-colors duration-300"
                             [ngClass]="getStepCircleClass(step.id)">
                            @if (currentStep() > step.id) {
                                <i class="ph-bold ph-check text-sm text-white"></i>
                            } @else {
                                <i [class]="'ph-bold text-sm ' + step.icon" [ngClass]="currentStep() === step.id ? 'text-[#5252FF]' : 'text-gray-400'"></i>
                            }
                        </div>

                        <!-- Textos do Passo -->
                        <div class="pb-2">
                            <p class="text-[11px] font-bold uppercase tracking-widest mb-0.5"
                               [ngClass]="currentStep() === step.id ? 'text-gray-900' : 'text-gray-500'">
                                Passo {{ step.id }}
                            </p>
                            <h3 class="text-[15px] font-semibold"
                                [ngClass]="currentStep() >= step.id ? 'text-gray-900' : 'text-gray-400'">
                                {{ step.title }}
                            </h3>
                            <p class="text-[13px] font-medium mt-1"
                               [ngClass]="currentStep() === step.id ? 'text-[#5252FF]' : 'text-gray-400'">
                                @if (currentStep() > step.id) { Completo }
                                @else if (currentStep() === step.id) { Em progresso }
                                @else { Pendente }
                            </p>
                        </div>
                    </div>
                }
            </div>
        </div>
    </aside>

    <!-- Área Principal do Formulário -->
    <main class="flex-1 flex flex-col relative bg-white">
        
        <!-- Header da Área de Form -->
        <header class="flex items-center justify-between p-6 md:px-12 md:py-8">
            <button (click)="prevStep()" 
                    class="flex items-center gap-2 text-sm font-semibold text-gray-500 hover:text-gray-900 transition-colors cursor-pointer"
                    [class.invisible]="currentStep() === 1">
                <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center"><i class="ph-bold ph-caret-left"></i></div>
                Voltar
            </button>
            <div class="text-sm font-semibold text-gray-400 flex items-center gap-1.5" [class.invisible]="isEditing()">
                Rascunho salvo <i class="ph-fill ph-cloud-check text-[#5252FF] text-lg"></i>
            </div>
        </header>

        <!-- Container do Formulário Centrado -->
        <div class="flex-1 flex flex-col max-w-[560px] w-full mx-auto px-6 pb-20 animate-fade-in pt-4 md:pt-8">
            
            <div class="text-center mb-10">
                <h2 class="text-3xl font-bold text-gray-900 tracking-tight mb-3">{{ currentStepData().title }}</h2>
                <p class="text-[15px] text-gray-500 font-medium">{{ currentStepData().desc }}</p>
            </div>

            <form [formGroup]="productForm" class="flex-1">
                
                <!-- PASSO 1: INFORMAÇÕES GERAIS -->
                @if (currentStep() === 1) {
                    <div class="space-y-6 animate-fade-in">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1.5">Título do Produto</label>
                            <input type="text" formControlName="titulo" placeholder="Ex: Furadeira de Impacto Bosch" 
                                   class="w-full border border-gray-200 rounded-xl p-3.5 text-[15px] text-gray-900 outline-none focus:border-[#5252FF] focus:ring-1 focus:ring-[#5252FF] transition-all placeholder:text-gray-400">
                            @if (isFieldInvalid('titulo')) { <p class="text-xs text-red-500 mt-1.5">O título é obrigatório (mín. 3 letras).</p> }
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1.5">Descrição Detalhada</label>
                            <textarea formControlName="descricao" rows="6" placeholder="Descreva as características técnicas, uso recomendado e diferenciais do produto..." 
                                      class="w-full border border-gray-200 rounded-xl p-3.5 text-[15px] text-gray-900 outline-none focus:border-[#5252FF] focus:ring-1 focus:ring-[#5252FF] transition-all placeholder:text-gray-400 resize-none"></textarea>
                            @if (isFieldInvalid('descricao')) { <p class="text-xs text-red-500 mt-1.5">A descrição é obrigatória.</p> }
                        </div>
                    </div>
                }

                <!-- PASSO 2: MÍDIA E FOTOS -->
                @if (currentStep() === 2) {
                    <div class="space-y-6 animate-fade-in">
                        <div class="border-2 border-dashed border-gray-200 rounded-2xl p-8 text-center hover:border-[#5252FF] hover:bg-[#5252FF]/5 transition-all cursor-pointer group relative">
                            <input type="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" (change)="onFileSelected($event)" accept="image/*" multiple [disabled]="isUploading()">
                            
                            <div class="w-14 h-14 bg-gray-50 text-gray-400 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-[#5252FF]/10 group-hover:text-[#5252FF] transition-colors">
                                @if (isUploading()) {
                                    <i class="ph-bold ph-spinner animate-spin text-3xl text-[#5252FF]"></i>
                                } @else {
                                    <i class="ph-bold ph-image text-3xl"></i>
                                }
                            </div>
                            
                            <p class="text-[15px] text-gray-700 font-medium">
                                {{ isUploading() ? 'Processando imagens...' : 'Clique para carregar ou arraste as fotos' }}
                            </p>
                            <p class="text-xs text-gray-400 mt-1.5">Formatos suportados: JPG, PNG. Recomendado 1:1.</p>
                        </div>
                        
                        @if (images().length > 0) {
                            <div class="grid grid-cols-3 gap-4 mt-6">
                                @for (img of images(); track img; let i = $index) {
                                    <div class="relative group aspect-square rounded-xl overflow-hidden border border-gray-200 shadow-sm bg-gray-50">
                                        <img [src]="img" class="w-full h-full object-cover">
                                        
                                        <button type="button" (click)="removeImage(i)" class="absolute top-2 right-2 bg-white/90 text-red-500 p-1.5 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity shadow-sm hover:bg-red-50 cursor-pointer z-10">
                                            <i class="ph-bold ph-trash"></i>
                                        </button>
                                        
                                        @if (i === 0) {
                                            <div class="absolute bottom-0 left-0 right-0 bg-[#5252FF]/90 backdrop-blur-sm text-white text-[10px] font-bold text-center py-1 uppercase tracking-widest">
                                                Principal
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        } @else {
                            <div class="p-4 bg-amber-50 border border-amber-100 rounded-xl flex items-start gap-3">
                                <i class="ph-fill ph-warning-circle text-amber-500 text-lg mt-0.5"></i>
                                <div>
                                    <p class="text-sm font-bold text-amber-800">Nenhuma imagem adicionada</p>
                                    <p class="text-xs text-amber-700 mt-0.5">Produtos com fotos convertem até 80% mais. Você pode adicionar depois, se preferir.</p>
                                </div>
                            </div>
                        }
                    </div>
                }

                <!-- PASSO 3: CATEGORIZAÇÃO -->
                @if (currentStep() === 3) {
                    <div class="space-y-6 animate-fade-in">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">Código SKU (Identificador)</label>
                                <input type="text" formControlName="codigoControle" placeholder="Ex: PROD-001" 
                                       class="w-full border border-gray-200 rounded-xl p-3.5 text-[15px] text-gray-900 font-mono uppercase outline-none focus:border-[#5252FF] focus:ring-1 focus:ring-[#5252FF] transition-all placeholder:text-gray-400">
                                @if (isFieldInvalid('codigoControle')) { <p class="text-xs text-red-500 mt-1.5">Obrigatório.</p> }
                            </div>
                            
                            <div class="col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">Categoria Principal</label>
                                <div class="relative">
                                    <select formControlName="categoriaId" class="w-full border border-gray-200 rounded-xl p-3.5 text-[15px] text-gray-900 outline-none focus:border-[#5252FF] focus:ring-1 focus:ring-[#5252FF] transition-all appearance-none cursor-pointer">
                                        <option value="" disabled>Selecione uma categoria...</option>
                                        @for (cat of categorias(); track cat.id) {
                                            <option [value]="cat.id">{{ cat.nome }}</option>
                                        }
                                    </select>
                                    <i class="ph-bold ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                </div>
                                @if (isFieldInvalid('categoriaId')) { <p class="text-xs text-red-500 mt-1.5">Selecione uma categoria.</p> }
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">Peso Físico (Kg)</label>
                                <input type="number" formControlName="pesoKg" step="0.1" placeholder="0.0" 
                                       class="w-full border border-gray-200 rounded-xl p-3.5 text-[15px] text-gray-900 outline-none focus:border-[#5252FF] focus:ring-1 focus:ring-[#5252FF] transition-all placeholder:text-gray-400">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">Dimensões (CxLxA)</label>
                                <input type="text" formControlName="dimensoes" placeholder="ex: 10x20x15" 
                                       class="w-full border border-gray-200 rounded-xl p-3.5 text-[15px] text-gray-900 outline-none focus:border-[#5252FF] focus:ring-1 focus:ring-[#5252FF] transition-all placeholder:text-gray-400">
                            </div>

                            <div class="col-span-2 pt-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Visibilidade na Loja</label>
                                <div class="flex p-1 bg-gray-100 rounded-xl w-full">
                                    <button type="button" (click)="productForm.get('ativo')?.setValue(true)" 
                                            [class]="productForm.get('ativo')?.value ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500'"
                                            class="flex-1 py-2.5 text-sm font-bold rounded-lg transition-all cursor-pointer">Ativo</button>
                                    <button type="button" (click)="productForm.get('ativo')?.setValue(false)" 
                                            [class]="!productForm.get('ativo')?.value ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500'"
                                            class="flex-1 py-2.5 text-sm font-bold rounded-lg transition-all cursor-pointer">Oculto</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <!-- PASSO 4: VALORES E ESTOQUE -->
                @if (currentStep() === 4) {
                    <div class="space-y-6 animate-fade-in">
                        <div class="p-5 bg-blue-50/50 border border-blue-100 rounded-2xl">
                            <label class="block text-sm font-bold text-gray-900 mb-1.5">Preço Base de Venda (R$)</label>
                            <input type="number" formControlName="preco" placeholder="0.00" 
                                   class="w-full border border-gray-200 rounded-xl p-3.5 text-lg font-bold text-gray-900 outline-none focus:border-[#5252FF] focus:ring-1 focus:ring-[#5252FF] transition-all placeholder:text-gray-400 shadow-sm">
                            @if (isFieldInvalid('preco')) { <p class="text-xs text-red-500 mt-1.5">Defina o preço de venda.</p> }
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1.5">Preço Promocional (Opcional)</label>
                            <input type="number" formControlName="precoPromocional" placeholder="0.00" 
                                   class="w-full border border-gray-200 rounded-xl p-3.5 text-[15px] text-[#5252FF] font-bold outline-none focus:border-[#5252FF] focus:ring-1 focus:ring-[#5252FF] transition-all placeholder:text-gray-400">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1.5">Quantidade Inicial em Estoque</label>
                            <div class="flex items-center gap-3">
                                <input type="number" formControlName="estoque" placeholder="0" [readonly]="isEditing()"
                                       class="w-full border border-gray-200 rounded-xl p-3.5 text-[15px] text-gray-900 outline-none focus:border-[#5252FF] focus:ring-1 focus:ring-[#5252FF] transition-all placeholder:text-gray-400 read-only:bg-gray-50 read-only:text-gray-500 read-only:cursor-not-allowed">
                                
                                @if (isEditing()) {
                                    <button type="button" (click)="openStockModal(null)" class="px-5 py-3.5 bg-[#5252FF]/10 text-[#5252FF] font-bold rounded-xl hover:bg-[#5252FF]/20 transition-colors shrink-0" title="Ajustar Estoque">
                                        Ajustar
                                    </button>
                                }
                            </div>
                            @if (isEditing()) {
                                <p class="text-[11px] text-gray-500 mt-2">Para produtos existentes, utilize o botão "Ajustar" para registrar entradas e saídas mantendo o histórico.</p>
                            }
                            @if (isFieldInvalid('estoque')) { <p class="text-xs text-red-500 mt-1.5">Obrigatório.</p> }
                        </div>
                    </div>
                }
                
                <!-- Botões Fixos de Controle -->
                <div class="mt-12">
                    @if (currentStep() < steps.length) {
                        <button type="button" (click)="nextStep()" 
                                class="w-full py-4 bg-[#5252FF] hover:bg-[#4040E6] text-white font-bold rounded-xl text-[15px] transition-colors shadow-lg shadow-[#5252FF]/20 active:scale-[0.99] cursor-pointer">
                            Próximo Passo
                        </button>
                    } @else {
                        <button type="button" (click)="onSubmit()" [disabled]="isLoading() || isUploading()"
                                class="w-full py-4 bg-gray-900 hover:bg-black text-white font-bold rounded-xl text-[15px] transition-colors shadow-lg shadow-gray-900/20 active:scale-[0.99] cursor-pointer disabled:opacity-70 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            @if (isLoading()) {
                                <i class="ph-bold ph-spinner animate-spin"></i> Finalizando...
                            } @else if (isUploading()) {
                                <i class="ph-bold ph-spinner animate-spin"></i> Aguardando Imagens...
                            } @else {
                                <i class="ph-bold ph-check-circle"></i> {{ isEditing() ? 'Salvar Alterações' : 'Publicar Produto' }}
                            }
                        </button>
                    }
                </div>

            </form>
        </div>
    </main>
    
    <!-- Modal de Ajuste de Estoque (Apenas para edição) -->
    @if (showStockModal()) {
        <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-8 relative animate-scale-up-fast border border-white/20">
                <button (click)="showStockModal.set(false)" class="absolute top-6 right-6 w-10 h-10 rounded-full bg-gray-50 hover:bg-gray-100 text-gray-500 flex items-center justify-center transition-colors cursor-pointer">
                    <i class="ph-bold ph-x text-lg"></i>
                </button>
                
                <h3 class="text-[22px] font-bold text-gray-900 tracking-tight mb-6">Ajustar Estoque</h3>
                
                <form [formGroup]="stockForm" (submit)="confirmStockAdjustment()" class="space-y-5">
                    <div class="flex gap-3 p-1.5 bg-gray-100 rounded-[14px]">
                        <button type="button" (click)="stockForm.get('tipo')?.setValue(enumTipo.ENTRADA)"
                                [class]="stockForm.get('tipo')?.value === enumTipo.ENTRADA ? 'bg-white text-emerald-600 shadow-sm' : 'text-gray-500'"
                                class="flex-1 py-2.5 text-sm font-bold rounded-xl transition-all flex items-center justify-center gap-2 cursor-pointer">
                            <i class="ph-bold ph-plus-circle"></i> Entrada
                        </button>
                        <button type="button" (click)="stockForm.get('tipo')?.setValue(enumTipo.SAIDA)"
                                [class]="stockForm.get('tipo')?.value === enumTipo.SAIDA ? 'bg-white text-red-600 shadow-sm' : 'text-gray-500'"
                                class="flex-1 py-2.5 text-sm font-bold rounded-xl transition-all flex items-center justify-center gap-2 cursor-pointer">
                            <i class="ph-bold ph-minus-circle"></i> Saída
                        </button>
                    </div>
                    
                    <div>
                        <label class="block text-[11px] font-bold text-gray-500 uppercase tracking-widest mb-1.5 ml-1">Quantidade</label>
                        <input type="number" formControlName="quantidade" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3.5 outline-none focus:border-[#5252FF] font-bold text-lg text-center">
                    </div>
                    
                    <div>
                        <label class="block text-[11px] font-bold text-gray-500 uppercase tracking-widest mb-1.5 ml-1">Justificativa</label>
                        <input type="text" formControlName="motivo" placeholder="Ex: Reposição, Perda, Ajuste de balanço" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3.5 outline-none focus:border-[#5252FF] text-sm">
                    </div>
                    
                    <button type="submit" [disabled]="isAdjustingStock() || stockForm.invalid" class="w-full mt-2 py-4 bg-gray-900 text-white font-bold rounded-xl hover:bg-black transition-colors disabled:opacity-70 disabled:cursor-not-allowed">
                        {{ isAdjustingStock() ? 'Processando...' : 'Confirmar Ajuste' }}
                    </button>
                </form>
            </div>
        </div>
    }
</div>