<section class="container mx-auto px-4 lg:px-8 py-8 mt-6 min-h-screen">
    <!-- CSS Embutido para fazer o Range Slider Duplo funcionar perfeitamente sem libs -->
    <style>
        .dual-range-container input[type="range"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            pointer-events: none;
            -webkit-appearance: none;
            background: transparent;
            outline: none;
        }
        .dual-range-container input[type="range"]::-webkit-slider-thumb {
            pointer-events: all;
            width: 16px;
            height: 16px;
            -webkit-appearance: none;
            border-radius: 50%;
            background: white;
            border: 2px solid #ef4444; /* tailwind red-500 equivalent */
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .dual-range-container input[type="range"]::-moz-range-thumb {
            pointer-events: all;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            border: 2px solid #ef4444;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
    </style>

    <div class="flex flex-col lg:flex-row gap-10 items-start">
        <!-- SIDEBAR DE FILTROS (Esquerda) -->
        <aside
            class="w-full lg:w-64 flex-shrink-0 sticky top-24 max-h-[calc(100vh-8rem)] overflow-y-auto custom-scrollbar pr-2 pb-10"
        >
            <!-- Categoria -->
            <div class="mb-8">
                <h2 class="text-base font-bold text-gray-900 mb-4">
                    Categoria
                </h2>

                @if (filtros.categoriaId) {
                    <!-- Estado: Categoria Selecionada Destacada -->
                    <button
                        (click)="selecionarCategoria('')"
                        class="flex items-center text-sm text-gray-500 hover:text-brand transition mb-3"
                    >
                        <i class="ph ph-arrow-left mr-2"></i> Voltar
                    </button>
                    <div
                        class="flex items-center justify-between text-brand font-medium text-sm bg-brand-50 px-3 py-2.5 rounded-md border border-brand/20"
                    >
                        <span class="flex items-center">
                            <i class="ph-fill ph-check-circle mr-2"></i>
                            @for (cat of categoriasDisponiveis; track cat.id) {
                                @if (cat.id === filtros.categoriaId) {
                                    {{ cat.nome }}
                                }
                            }
                        </span>
                        <button
                            (click)="selecionarCategoria('')"
                            class="text-brand hover:text-red-700"
                        >
                            <i class="ph ph-x"></i>
                        </button>
                    </div>
                } @else {
                    <!-- Estado: Lista de Categorias -->
                    <ul class="space-y-3 text-sm text-gray-700">
                        @for (cat of categoriasDisponiveis; track cat.id) {
                            <li>
                                <button
                                    (click)="selecionarCategoria(cat.id)"
                                    class="w-full text-left pl-2 py-1.5 rounded-md transition hover:bg-gray-50 text-gray-600 hover:text-brand"
                                >
                                    {{ cat.nome }}
                                </button>
                            </li>
                        }

                        @if (categoriasDisponiveis.length === 0) {
                            <li
                                class="pl-2 py-2 text-gray-400 text-xs animate-pulse"
                            >
                                Carregando categorias...
                            </li>
                        }
                    </ul>
                }
            </div>

            <!-- Preço (Com Range Slider Funcional) -->
            <div class="mb-8 border-t border-gray-100 pt-6">
                <div class="flex items-center justify-between mb-6">
                    <h2
                        class="text-sm font-bold uppercase text-gray-900 tracking-wide"
                    >
                        Faixa de Preço
                    </h2>
                    @if (
                        filtros.precoMin > 0 ||
                        filtros.precoMax < maxPrecoLimite
                    ) {
                        <button
                            type="button"
                            (click)="limparPreco()"
                            class="text-xs font-medium text-orange-600 hover:text-orange-800 hover:underline transition-colors"
                        >
                            Limpar
                        </button>
                    }
                </div>

                <div class="relative w-full h-2 mb-8 select-none">
                    <div
                        class="absolute w-full h-1.5 bg-gray-200 rounded-full top-0"
                    ></div>

                    <div
                        class="absolute h-1.5 bg-orange-500 rounded-full top-0 z-10"
                        [style.left.%]="percentMin"
                        [style.right.%]="100 - percentMax"
                    ></div>

                    <div class="absolute w-full h-full top-[-3px]">
                        <input
                            type="range"
                            min="0"
                            [max]="maxPrecoLimite"
                            step="10"
                            [(ngModel)]="filtros.precoMin"
                            (input)="aplicarFiltros()"
                        />
                        <input
                            type="range"
                            min="0"
                            [max]="maxPrecoLimite"
                            step="10"
                            [(ngModel)]="filtros.precoMax"
                            (input)="aplicarFiltros()"
                        />
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <div class="relative flex-1 group">
                        <span
                            class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs font-bold pointer-events-none group-focus-within:text-orange-500"
                            >R$</span
                        >
                        <input
                            type="number"
                            [(ngModel)]="filtros.precoMin"
                            (blur)="aplicarFiltros()"
                            (keyup.enter)="aplicarFiltros()"
                            class="w-full pl-8 pr-2 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all text-center"
                        />
                    </div>

                    <span class="text-gray-400 font-medium">-</span>

                    <div class="relative flex-1 group">
                        <span
                            class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs font-bold pointer-events-none group-focus-within:text-orange-500"
                            >R$</span
                        >
                        <input
                            type="number"
                            [(ngModel)]="filtros.precoMax"
                            (blur)="aplicarFiltros()"
                            (keyup.enter)="aplicarFiltros()"
                            class="w-full pl-8 pr-2 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all text-center"
                        />
                    </div>
                </div>
            </div>

            <!-- Marcas -->
            <div class="mb-8 border-t border-gray-100 pt-6">
                <h2 class="text-base font-bold text-gray-900 mb-4">Marcas</h2>

                <div class="space-y-3">
                    @for (marca of marcasDisponiveis; track marca) {
                        <label class="flex items-center cursor-pointer group">
                            <input
                                type="checkbox"
                                [value]="marca"
                                (change)="toggleMarca(marca)"
                                [checked]="filtros.marcas?.includes(marca)"
                                class="w-4 h-4 rounded border-gray-300 text-brand focus:ring-brand mr-3 cursor-pointer"
                            />
                            <span
                                class="text-sm text-gray-700 group-hover:text-brand transition"
                                >{{ marca }}</span
                            >
                        </label>
                    }
                </div>
            </div>

            <!-- Avaliação -->
            <div class="mb-8 border-t border-gray-100 pt-6">
                <h2 class="text-base font-bold text-gray-900 mb-4">
                    Avaliação
                </h2>

                <div class="space-y-3">
                    @for (rating of [4, 3, 2, 1]; track rating) {
                        <label class="flex items-center cursor-pointer group">
                            <input
                                type="radio"
                                name="avaliacao"
                                [value]="rating"
                                [(ngModel)]="filtros.avaliacao"
                                (change)="aplicarFiltros()"
                                class="w-4 h-4 border-gray-300 text-brand focus:ring-brand mr-3 cursor-pointer"
                            />
                            <div class="flex text-yellow-400 text-sm">
                                <!-- Estrelas Preenchidas -->
                                @for (
                                    star of [].constructor(rating);
                                    track $index
                                ) {
                                    <i class="ph-fill ph-star"></i>
                                }
                                <!-- Estrelas Vazias -->
                                @for (
                                    star of [].constructor(5 - rating);
                                    track $index
                                ) {
                                    <i class="ph ph-star text-gray-300"></i>
                                }
                                <span class="text-gray-500 text-xs ml-2"
                                    >& acima</span
                                >
                            </div>
                        </label>
                    }
                </div>
            </div>
        </aside>

        <!-- ÁREA DE RESULTADOS E FILTROS ATIVOS (Direita) -->
        <main class="flex-1 w-full flex flex-col min-h-[500px]">
            <div class="mb-6">
                <div
                    class="flex flex-col md:flex-row md:items-center justify-between mb-4 gap-4 border-b border-gray-100 pb-4"
                >
                    <p class="text-gray-800 text-base">
                        Encontrados
                        <span class="font-bold text-gray-900"
                            >{{ totalElements }} produtos</span
                        >
                    </p>
                    <div class="flex items-center gap-3">
                        <label
                            for="sortOrder"
                            class="text-sm text-gray-500 hidden sm:block"
                            >Ordenar por:</label
                        >
                        <div class="relative">
                            <select
                                id="sortOrder"
                                [(ngModel)]="ordenacaoAtual"
                                (change)="mudarOrdenacao()"
                                class="appearance-none bg-white border border-gray-300 text-gray-700 text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full pl-3 pr-8 py-2 cursor-pointer transition-colors hover:border-orange-400"
                            >
                                @for (
                                    opcao of opcoesOrdenacao;
                                    track opcao.value
                                ) {
                                    <option [value]="opcao.value">
                                        {{ opcao.label }}
                                    </option>
                                }
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500"
                            >
                                <i class="ph-bold ph-caret-down text-xs"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div
                    class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mt-4"
                >
                    <div class="flex flex-wrap items-center gap-2">
                        @for (filtro of filtrosAtivosList; track filtro.key) {
                            <div
                                class="flex items-center gap-1 bg-gray-100 text-gray-700 text-sm px-3 py-1.5 rounded-md"
                            >
                                {{ filtro.label }}
                                <button
                                    (click)="removerFiltro(filtro.key)"
                                    class="text-gray-400 hover:text-gray-800 ml-1 transition"
                                >
                                    <i class="ph ph-x text-xs"></i>
                                </button>
                            </div>
                        }

                        @if (filtrosAtivosList.length > 0) {
                            <button
                                (click)="limparFiltros()"
                                class="text-sm px-3 py-1.5 border border-gray-200 rounded-md text-gray-600 hover:bg-gray-50 transition ml-1"
                            >
                                Limpar filtros
                            </button>
                        }
                    </div>

                    <div class="flex items-center gap-3">
                        <div
                            class="flex bg-gray-50 rounded-md p-1 border border-gray-100"
                        >
                            <button
                                (click)="viewMode = 'grid'"
                                class="p-1.5 rounded transition"
                                [ngClass]="
                                    viewMode === 'grid'
                                        ? 'bg-white shadow-sm text-gray-800'
                                        : 'text-gray-400 hover:text-gray-600'
                                "
                            >
                                <i class="ph-fill ph-squares-four text-lg"></i>
                            </button>
                            <button
                                (click)="viewMode = 'list'"
                                class="p-1.5 rounded transition"
                                [ngClass]="
                                    viewMode === 'list'
                                        ? 'bg-white shadow-sm text-gray-800'
                                        : 'text-gray-400 hover:text-gray-600'
                                "
                            >
                                <i class="ph ph-list text-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            @if (loading) {
                <div
                    class="grid gap-4 lg:gap-6 flex-1 content-start"
                    [ngClass]="
                        viewMode === 'grid'
                            ? 'grid-cols-2 xl:grid-cols-3'
                            : 'grid-cols-1'
                    "
                >
                    @for (
                        i of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
                        track i
                    ) {
                        <article
                            class="bg-transparent animate-pulse transition-all duration-300"
                            [ngClass]="
                                viewMode === 'list'
                                    ? 'flex flex-col sm:flex-row items-start sm:items-center gap-6 p-4 border border-gray-100 rounded-xl'
                                    : 'flex flex-col'
                            "
                        >
                            <div
                                class="bg-gray-200 rounded-lg"
                                [ngClass]="
                                    viewMode === 'list'
                                        ? 'w-full sm:w-48 h-48 flex-shrink-0'
                                        : 'w-full aspect-square mb-3'
                                "
                            ></div>

                            <div
                                [ngClass]="
                                    viewMode === 'list'
                                        ? 'flex-1 flex flex-col justify-center w-full'
                                        : 'w-full'
                                "
                            >
                                <div
                                    class="h-2 bg-gray-200 rounded w-1/4 mb-2"
                                ></div>
                                <div
                                    class="h-3.5 bg-gray-200 rounded w-full mb-2"
                                ></div>
                                <div
                                    class="h-3.5 bg-gray-200 rounded w-4/5 mb-4"
                                ></div>

                                @if (viewMode === "list") {
                                    <div
                                        class="h-2.5 bg-gray-200 rounded w-full mb-1"
                                    ></div>
                                    <div
                                        class="h-2.5 bg-gray-200 rounded w-5/6 mb-4"
                                    ></div>
                                }

                                <div class="flex gap-1.5 mb-3">
                                    <div
                                        class="w-2.5 h-2.5 bg-gray-200 rounded-full"
                                    ></div>
                                    <div
                                        class="w-2.5 h-2.5 bg-gray-200 rounded-full"
                                    ></div>
                                    <div
                                        class="w-2.5 h-2.5 bg-gray-200 rounded-full"
                                    ></div>
                                    <div
                                        class="w-2.5 h-2.5 bg-gray-200 rounded-full"
                                    ></div>
                                    <div
                                        class="w-2.5 h-2.5 bg-gray-200 rounded-full"
                                    ></div>
                                </div>

                                <div
                                    class="h-4 bg-gray-200 rounded w-1/3"
                                    [ngClass]="viewMode === 'list' ? 'h-5' : ''"
                                ></div>
                            </div>
                        </article>
                    }
                </div>
            }

            @if (!loading) {
                <div
                    class="grid gap-4 lg:gap-6 flex-1 content-start"
                    [ngClass]="
                        viewMode === 'grid'
                            ? 'grid-cols-2 xl:grid-cols-3'
                            : 'grid-cols-1'
                    "
                >
                    @for (produto of produtos; track produto.id) {
                        <app-product-card
                            [product]="produto"
                            [viewMode]="viewMode"
                        ></app-product-card>
                    }

                    @if (produtos.length === 0) {
                        <div
                            class="col-span-full flex flex-col items-center justify-center py-20 text-gray-500 bg-gray-50 rounded-xl border border-dashed border-gray-200 mt-4"
                        >
                            <i
                                class="ph ph-magnifying-glass text-4xl text-gray-300 mb-3"
                            ></i>
                            <p class="text-lg font-medium text-gray-800">
                                Nenhum produto encontrado
                            </p>
                            <p class="text-sm">
                                Tente remover alguns filtros para ver mais
                                resultados.
                            </p>
                        </div>
                    }
                </div>
            }
        </main>
    </div>
</section>
